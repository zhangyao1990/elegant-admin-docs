---
title: 打包和部署
date: 2023-07-12 09:50:07
permalink: /pages/574c7a/
article: false
---

## 测试环境打包

```bash
  pnpm run build:test
```
## 预发布环境打包

```bash
  pnpm run build:pre
```
## 生产环境打包

```bash
  pnpm run build:pro
```

构建打包成功之后，会在根目录生成 dist 文件夹，里面就是构建打包好的文件。

## 本地预览
生成好的 dist 文件夹一般需要部署至服务器才算部署发布成功，但为了保证构建出来的文件能正常运行，开发者通常希望能在本地先预览一下，可执行 pnpm run serve:test 命令预览构建出的文件夹。

## 打包分析
``` bash
pnpm report
```
## 部署
比如我们在 vite.config.ts 配置了两个后端地址，如下

```js

proxy: {
    '/nethos': {
        target: 'http://127.0.0.1:3000/',
            changeOrigin: true,
            rewrite: path => path.replace(/^\/nethos/, 'nethos')
    }
    '/otherApi': {
    	target: 'http://127.0.0.1:9000',
    	changeOrigin: true,
    	rewrite: path => path.replace(/^\/otherApi/, 'otherApi')
    }
}
```
来到 /usr/local/etc/nginx/nginx.conf 这个 nginx 的配置文件，修改成如下配置即可

```bash
location / {
    root   html;
    index  index.html index.htm;
    # 用于配合前端路由为h5模式使用，防止刷新404 https://router.vuejs.org/zh/guide/essentials/history-mode.html#nginx
    try_files $uri $uri/ /index.html;
}

# 第一个代理后端地址（vite.config.ts里叫 /api，这里也要保持一致）
location /nethos {
    # 如果后端在本地比如127.0.0.1或者localhost请解开下面的rewrite注释即可
    # rewrite  ^.+nethos/?(.*)$ /$1 break;
    # 这里填写后端地址（后面一定不要忘记添加 / ）
    proxy_pass http://127.0.0.1:3000/;
    proxy_set_header Host $host;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_redirect default;
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
}

# 第二个代理后端地址（vite.config.ts里叫 /otherApi，这里也要保持一致）
location /otherApi {
    # 如果后端在本地比如127.0.0.1或者localhost请解开下面的rewrite注释即可
    # rewrite  ^.+otherApi/?(.*)$ /$1 break;
    # 这里填写后端地址（后面一定不要忘记添加 / ）
    proxy_pass http://127.0.0.1:9000/;
    proxy_set_header Host $host;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_redirect default;
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
}
```
将上面的配置放到/usr/local/etc/nginx/nginx.conf文件的server 里

## 开启 gzip 压缩
1. 来到 .env.production，将 VITE_BUILD_COMPRESS 等于 gzip，如下
```bash
# 是否在打包时开启压缩，支持 gzip 和 brotli
VITE_BUILD_COMPRESS = gzip
```
2. 配置 nginx.config 如下

```bash
http {
  # 开启gzip
  gzip on;
  # https://blog.csdn.net/fxss5201/article/details/106535475
  gzip_static on;
  gzip_proxied any;
  # 低于1kb的资源不压缩
  gzip_min_length 1k;
  gzip_buffers 4 16k;
  gzip_comp_level 2;
  # 需要压缩的类型
  gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
  # 配置禁用gzip条件，支持正则。此处表示ie6及以下不启用gzip（因为ie低版本不支持）
  gzip_disable "MSIE [1-6]\.";
  # 是否添加“Vary: Accept-Encoding”响应头
  gzip_vary off;
}
```
开启 gzip（资源被压缩后会比未开启时小很多 🐮）
